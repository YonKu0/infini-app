variant: fcos
version: 1.6.0

passwd:
  users:
    - name: infini-ops
      groups: [sudo, docker]
      home_dir: /home/infini-ops
      shell: /bin/bash
      ssh_authorized_keys:
        # SSH public key for infini-ops user
        - ssh-ed25519 [YOUR_PUBLIC_KEY] infini-ops@infini-app

storage:
  files:
    # Script to assign random static IP on first boot
    - path: /usr/local/bin/set-random-ip.sh
      mode: 0755
      user:
        name: infini-ops
      contents:
        source: "https://raw.githubusercontent.com/YonKu0/infini-app/refs/heads/main/scripts/set-random-ip.sh"
        verification:
          hash: "sha256-4adc92c5a4714bf5b10c2cd78f8c3bc63e52e80151c216f8944b6a33795d164d"

    # Configure Zincati’s maintenance window
    - path: /etc/zincati/config.d/maintenance.toml
      mode: 0644
      contents:
        inline: |
          [updates]
          time_zone = "UTC"
          # Poll for new commits every hour
          check_interval = "1h"
          # Only reboot between 02:00–03:00 UTC
          reboot = "02:00/03:00"

systemd:
  units:
    # Layer in Docker CE + Compose/Buildx via official Docker RPMs
    - name: rpm-ostree-install.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer Docker Compose & plugins via rpm-ostree
        ConditionFirstBoot=yes
        Wants=network-online.target
        After=network-online.target

        [Service]
        Type=oneshot
        ExecStartPre=/usr/bin/rpm-ostree cancel
        ExecStart=/usr/bin/rpm-ostree install -y \
          https://download.docker.com/linux/fedora/41/x86_64/stable/Packages/docker-buildx-plugin-0.23.0-1.fc41.x86_64.rpm \
          https://download.docker.com/linux/fedora/41/x86_64/stable/Packages/docker-compose-plugin-2.35.1-1.fc41.x86_64.rpm
        ExecStartPost=/usr/bin/systemctl reboot --no-wall
        RemainAfterExit=yes
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target

    # Assign random IP on first boot
    - name: set-random-ip.service
      enabled: true
      contents: |
        [Unit]
        Description=Set random static IP on first boot only
        ConditionFirstBoot=yes
        StartLimitIntervalSec=0
        StartLimitBurst=0
        Wants=network-online.target NetworkManager-wait-online.service
        After=network-online.target NetworkManager-wait-online.service

        [Service]
        Type=oneshot
        Restart=no
        ExecStartPre=/usr/bin/nm-online -q --timeout=30
        ExecStart=/usr/local/bin/set-random-ip.sh
        TimeoutStartSec=60
        RemainAfterExit=yes
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target

    # Enable Docker daemon
    - name: docker.service
      enabled: true
